\section{Agency Prototype}
Here we present a prototype to overcome the disruption in experiencing agency during action augmentation. Our proposed system controls an end-effector, here EMS, by leveraging EEG signals reflecting the intent to (inter)act. To control the interaction in real-time, an EEG classifier is used to discriminate between two user states: either the user is predicted to be in an \textit{idle} state, reflecting the absence of an intent to act-- or a \textit{pre-movement} state, indicating the presence of an intent to act. When the system predicts a \textit{pre-movement} state, EMS is triggered in real-time, augmenting the user's action even before their own voluntary motor command.

\subsection{Controlling actuated haptic experiences using brain signals reflecting the intent to interact}
% alternative headings:
% Triggering EMS using EEG Signals

To discriminate between the two \textit{action} states, we leveraged the EEG Readiness Potential (RP), or \textit{lateralized readiness potential}. It is an amplitude fluctuation that has frequently been observed preceding voluntary action~\cite{Deecke1969-bl, Libet1983-qu}. The RP is reliably observed at electrodes placed over the motor cortex contralateral to the acting hand. Since its measurable onset precedes the time of participants self-reported conscious movement intention, it has drawn much interest with respect to the debate on free will, see~\cite{Schurger2021-vp} for a recent neuroscientific perspective. However, evidence abounds for its role in action preparation. A RP is typically comprised of two stages: an early slow stage that begins up to two seconds before the actual movement and a late steep stage that starts about 400 milliseconds before movement. The first stage manifests in the pre-supplementary motor area and transfers to the premotor cortex shortly after. The second stage manifests contra-laterally in the primary motor cortex~\cite{Shibasaki2006-mt}. A recent study has shown that the RP is heavily ingrained in the subconscious mechanisms preceding movements that people cannot explicitly suppress~\cite{Schultze-Kraft2021-cu}. In their study,~\cite{Schultze-Kraft2021-cu} asked participants to find a way to perform voluntary movements while keeping accompanying RP amplitudes as small as possible. After each trial they informed participants about the strength of the RP in the current trial, so participants had a feedback metric to optimize for. They found participants unable to suppress their RP. This inability to suppress the RP renders it a reliable feature for classification.

\subsection{Prototype components}
Our system, depicted in Figure~\ref{}, comprised: (1) a 64-channel EEG system, (2) a 1 channel Electromyography (EMG) system, (3) a simple Arduino controlled switch, and (4) a medically-compliant EMS device connected via two electrodes worn on the arm. More information on the specific hardware specifications is given in the methods and user study sections below. To assist readers in replicating our prototype, we provide the necessary technical details and source code for data processing, classifier training, and real-time application\footnote{[anonymized]}. We used LSL\footnote{https://github.com/sccn/labstreaminglayer} to make the EEG and EMG data streams available in the network and synchronize the recordings of EEG data, motion capture, and an experiment marker stream that marked sections of the study procedure.

\missingfigure{show participant with measurement system and description next to each element}

\subsection{Brain-Computer Interface}
% alternative headings:
% Brain-Computer Interface to Detect EEG Readiness Potentials }
% Classifiying EEG Signals of the Intent to Interact

The presented classification scheme required individual training data per participant, as transfer learning remains challenging with EEG~\cite{Wan2021-zz}. Therefore, we initially obtained training data on a variant of our task that did not include any muscle stimulation. In our task, participants were instructed, following an initial waiting period, to tap a touchscreen at their own volition with their ring finger, see figure ~\ref{fig:teaser}. 

\subsubsection{Labelling movement classes using EMG}
To obtain behavioral labels at a high temporal resolution, we leveraged EMG from the flexor digitorum profundus to detect finger movement onsets of the ring finger. Subsequently the data were labelled into two classes: an \textit{idle} class representing resting background activity and a \textit{pre-movement} class, representing the intent to (inter-)act. To this end, EMG amplitudes of the second preceding the screen tap were band-pass filtered from 20 to 100 Hz and subsequently squared. Next, noisy data segments were determined. A segment was rejected as an outlier using Matlab's \textit{isoutlier} function using default parameters. To label the time of movement onset, the first sample where the amplitude exceeded the 95th percentile of the data epoch was selected. The two event classes were then defined as follows: \textit{pre-movement} from -1000 to 0 ms preceding the movement onsets and \textit{idle}, a one second data segment between trials where participants were looking at a fixation cross.
% from isoutlier documentation (mean segment amplitude exceeding 3 scaled median absolute deviation)

% \missingfigure{some picture from the setup and prototype}

\subsubsection{Selecting discriminative EEG channels}
In a first step to prepare the EEG data for classification, noisy data segments were rejected using the identical method as for rejection of EMG segments described above. Then, to decrease dimensionality of the EEG data, a selection of discriminative channels was conducted following an approach outlined by~\citep{Schultze-Kraft2021-cu} albeit with slight modifications.

First, for each channel and both \textit{idle} and \textit{pre-movement} class, the mean slope of the amplitude was obtained by fitting a linear regression, indicating how much the signal had changed in the course of the 1s segments. In line with the literature on the RP, there should be a change over time in the \textit{pre-movement} segment but not in the \textit{idle} segment. Then, all channels were sorted (1) in descending order by slope in the \textit{pre-movement} segments and (2) in ascending order by slope in the \textit{idle} segments. The idea was, that an ideal channel shows a strong change in signal over the course of a \textit{pre-movement} segment but shows no difference during a \textit{idle} segment. The ranks were joined and the 10 highest-ranking channels were selected. In any case, channels C3, C4, and Cz were included in the 10 selected channels for every participant even if they were not within the 10 highest ranks as these are most frequently reported in studies on the RP.

\subsubsection{Training of EEG classifier}
To classify EEG data a regularized linear discriminant analysis (LDA) was trained for each participant individually. The EEG classifier was then used in the test phase to detect RPs and trigger EMS. The classifier was trained using the slopes of the \textit{idle} and \textit{pre-movement} segments of the 10 most discriminative channels as features, hence comprising a 10 dimensional feature vector.
\todo{extend this after settling on a final feature set}

\subsubsection{Real-time application and EMS control}
During real-time application, the EEG data was buffered for the last second for the selected channels. The slope features were then computed and applied to the model. An Arduino was used to flip a switch whenever the EEG classifier predicted the \textit{pre-movement} class with an above .7 probability, thereby triggering the attached actuating hardware. 
\todo{this may still change, adapt accordingly later}
In our current prototype, we used a medically-compliant EMS device. We constrained the times when the switch could be flipped to specific moments in the experiment where participants were getting ready to perform an action, thereby limiting the impact of false-positive classification. 
% This guaranteed that participants experienced EMS only during movement preparation.


%%%% Resources

% old version
% First, the 10 channels with the strongest discrimination between \textit{pre-movement} and \textit{idle} segments were selected with the following procedure: For both \textit{pre-movement} and \textit{idle} the mean signal in the last 100 ms of each segment was subtracted from the mean signal in the first 100ms of the segment. The resulting value thus indicated how much the signal had changed in the course of the 1s segments. In line with the literature there should be a change over time in the \textit{pre-movement} segment but not in the \textit{idle} segment. Then, all channels were sorted (1) in descending order by the signal difference in the \textit{pre-movement} segments and (2) in ascending order by the signal difference in the \textit{idle} segments. The idea was, that an ideal channel shows a strong change in signal over the course of a \textit{pre-movement} segment but shows no difference during a \textit{idle} segment. The ranks were joined and the 10 best channels were selected. In any case, channels C3, C4 and Cz were kept for every participant as these are most frequently reported in studies on the RP.
% An EEG classifier was trained on \textit{pre-movement} and \textit{idle} data segments using 10 features from the 20 most informative EEG channels. To classify single-trial motion and EEG data we used a regularized linear discriminant analysis (LDA) that was trained for each participant individually. 
% These were baseline corrected by subtracting the mean of the last 100 ms preceding the segment. The features were concatenated across all 20 selected channels and 10 time windows to obtain a 200 dimensional spatiotemporal feature vector per \textit{pre-movement} and \textit{idle} segment.

% During the test phase, both classifiers were applied to the real-time data. With the motion data streaming at 90 Hz we subjected the current sample to the motion classifier. For the EEG data streaming at 250 Hz, the EEG data of the last 1000ms was buffered for the selected best channels and 10 windowed means per channel were computed. Identical to the training data, these features were baseline corrected by subtracting the mean from the last 100 ms preceding the last second, i.e. -1100 ms to -1000 ms, resulting in a 200 dimensional baseline corrected spatiotemporal feature vector. Hence, both classifiers yielded one output value at each sample point.